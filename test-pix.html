<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PIX Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .test-results {
            display: none;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .metric-item {
            padding: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 10px;
        }
        .metric-item h4 {
            margin: 0;
            font-weight: bold;
        }
        .webhook-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Teste de Integra√ß√£o PIX</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Instru√ß√µes:</strong>
                            <ol>
                                <li>Configure suas credenciais no arquivo <code>js/config.js</code></li>
                                <li>Clique em um dos bot√µes abaixo para testar</li>
                                <li>Preencha os dados do cliente no modal</li>
                                <li>Verifique se o PIX √© gerado corretamente</li>
                            </ol>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <button id="btn-1-mes" class="btn btn-primary w-100">
                                    <strong>1 m√™s</strong><br>
                                    <small>R$ 19,90</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button id="btn-3-meses" class="btn btn-success w-100">
                                    <strong>3 meses</strong><br>
                                    <small>R$ 41,90 (30% off)</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button id="btn-6-meses" class="btn btn-warning w-100">
                                    <strong>6 meses</strong><br>
                                    <small>R$ 59,90 (50% off)</small>
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button id="testConnection" class="btn btn-outline-secondary">
                                <i class="fas fa-wifi"></i> Testar Conex√£o com API
                            </button>
                        </div>

                        <div id="testResults" class="mt-3 test-results">
                            <div class="alert alert-success">
                                <strong>Teste de Conex√£o:</strong> <span id="connectionStatus"></span>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Logs Detalhados -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-terminal"></i> Logs Detalhados
                                </h5>
                                <div>
                                    <button id="clearLogs" class="btn btn-sm btn-outline-secondary me-2">
                                        <i class="fas fa-trash"></i> Limpar
                                    </button>
                                    <button id="exportLogs" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body p-0">
                                    <div id="logContainer" class="p-3 log-container">
                                        <div class="text-muted text-center py-3">
                                            <i class="fas fa-info-circle"></i> 
                                            Os logs aparecer√£o aqui conforme voc√™ testa a integra√ß√£o
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb"></i> 
                                    <strong>Dica:</strong> Abra o console do navegador (F12) para logs ainda mais detalhados
                                </small>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Debug Avan√ßado -->
                        <div class="mt-4">
                            <h5><i class="fas fa-bug"></i> Debug Avan√ßado</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <button id="testCredentials" class="btn btn-outline-info w-100 mb-2">
                                        <i class="fas fa-key"></i> Testar Credenciais
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button id="testProxy" class="btn btn-outline-warning w-100 mb-2">
                                        <i class="fas fa-server"></i> Testar Proxy
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <button id="validateData" class="btn btn-outline-success w-100 mb-2">
                                        <i class="fas fa-check-circle"></i> Validar Dados
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button id="showConfig" class="btn btn-outline-secondary w-100 mb-2">
                                        <i class="fas fa-cog"></i> Mostrar Config
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Webhook -->
                        <div class="mt-4">
                            <h5><i class="fas fa-webhook"></i> Teste de Webhook</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <button id="testWebhook" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-play"></i> Testar Webhook
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button id="simulatePaid" class="btn btn-outline-success w-100 mb-2">
                                        <i class="fas fa-check"></i> Simular PAGO
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button id="simulateCreated" class="btn btn-outline-info w-100 mb-2">
                                        <i class="fas fa-plus"></i> Simular CRIADO
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <button id="testCallbackUrl" class="btn btn-outline-warning w-100 mb-2">
                                        <i class="fas fa-link"></i> Testar Callback URL
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button id="clearWebhookLogs" class="btn btn-outline-danger w-100 mb-2">
                                        <i class="fas fa-trash"></i> Limpar Logs Webhook
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Idempot√™ncia -->
                        <div class="mt-4">
                            <h5><i class="fas fa-shield-alt"></i> Teste de Idempot√™ncia</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <button id="testIdempotency" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-repeat"></i> Testar Duplica√ß√£o
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button id="showCache" class="btn btn-outline-info w-100 mb-2">
                                        <i class="fas fa-database"></i> Ver Cache
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button id="clearCache" class="btn btn-outline-warning w-100 mb-2">
                                        <i class="fas fa-broom"></i> Limpar Cache
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Monitoramento -->
                        <div class="mt-4">
                            <h5><i class="fas fa-chart-line"></i> Monitoramento e M√©tricas</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <button id="getMetrics" class="btn btn-outline-success w-100 mb-2">
                                        <i class="fas fa-chart-bar"></i> M√©tricas
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="getStats" class="btn btn-outline-info w-100 mb-2">
                                        <i class="fas fa-chart-pie"></i> Estat√≠sticas
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="monitorStatus" class="btn btn-outline-warning w-100 mb-2">
                                        <i class="fas fa-heartbeat"></i> Status
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button id="performanceTest" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-tachometer-alt"></i> Performance
                                    </button>
                                </div>
                            </div>
                            
                            <!-- M√©tricas em Tempo Real -->
                            <div class="mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-tachometer-alt"></i> M√©tricas em Tempo Real</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="metric-item">
                                                    <h4 id="metricTransactions" class="text-primary">0</h4>
                                                    <small>Transa√ß√µes</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-item">
                                                    <h4 id="metricSuccess" class="text-success">0</h4>
                                                    <small>Sucessos</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-item">
                                                    <h4 id="metricErrors" class="text-danger">0</h4>
                                                    <small>Erros</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-item">
                                                    <h4 id="metricAvgTime" class="text-info">0ms</h4>
                                                    <small>Tempo M√©dio</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/pix-integration.js"></script>

    <script>
        // Sistema de logs detalhado
        class DetailedLogger {
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
            }

            log(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    data: data ? JSON.stringify(data, null, 2) : null
                };
                
                this.logs.unshift(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }

                // Log no console
                const consoleMessage = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
                if (data) {
                    console.log(consoleMessage, data);
                } else {
                    console.log(consoleMessage);
                }

                // Atualizar interface
                this.updateLogDisplay();
            }

            info(message, data = null) {
                this.log('INFO', message, data);
            }

            error(message, data = null) {
                this.log('ERROR', message, data);
            }

            warn(message, data = null) {
                this.log('WARN', message, data);
            }

            debug(message, data = null) {
                this.log('DEBUG', message, data);
            }

            updateLogDisplay() {
                const logContainer = document.getElementById('logContainer');
                if (logContainer) {
                    const html = this.logs.slice(0, 20).map(log => {
                        const levelClass = log.level.toLowerCase();
                        const dataHtml = log.data ? `<pre class="small text-muted">${log.data}</pre>` : '';
                        return `
                            <div class="log-entry border-bottom py-2">
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-${levelClass === 'error' ? 'danger' : levelClass === 'warn' ? 'warning' : levelClass === 'info' ? 'info' : 'secondary'}">${log.level}</span>
                                    <small class="text-muted">${log.timestamp}</small>
                                </div>
                                <div class="mt-1">${log.message}</div>
                                ${dataHtml}
                            </div>
                        `;
                    }).join('');
                    logContainer.innerHTML = html;
                }
            }

            clear() {
                this.logs = [];
                this.updateLogDisplay();
            }
        }

        // Instanciar logger
        const logger = new DetailedLogger();

        // Sistema de Idempot√™ncia
        class IdempotencyManager {
            constructor() {
                this.cache = new Map();
                this.ttl = 24 * 60 * 60 * 1000; // 24 horas
                this.loadFromStorage();
            }

            isTransactionProcessed(transactionId) {
                const cached = this.cache.get(transactionId);
                if (!cached) return false;
                
                // Verificar se expirou
                if (Date.now() - cached.timestamp > this.ttl) {
                    this.cache.delete(transactionId);
                    this.saveToStorage();
                    return false;
                }
                
                return true;
            }

            markTransactionAsProcessed(transactionId, event, data = null) {
                this.cache.set(transactionId, {
                    timestamp: Date.now(),
                    event: event,
                    data: data,
                    processed: true
                });
                this.saveToStorage();
            }

            getTransactionInfo(transactionId) {
                return this.cache.get(transactionId);
            }

            clearCache() {
                this.cache.clear();
                this.saveToStorage();
            }

            getCacheStats() {
                return {
                    size: this.cache.size,
                    entries: Array.from(this.cache.entries()).map(([id, data]) => ({
                        id,
                        timestamp: new Date(data.timestamp).toISOString(),
                        event: data.event,
                        age: Date.now() - data.timestamp
                    }))
                };
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('idempotency_cache');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.cache = new Map(data);
                    }
                } catch (error) {
                    logger.error('Erro ao carregar cache de idempot√™ncia', error);
                }
            }

            saveToStorage() {
                try {
                    const data = Array.from(this.cache.entries());
                    localStorage.setItem('idempotency_cache', JSON.stringify(data));
                } catch (error) {
                    logger.error('Erro ao salvar cache de idempot√™ncia', error);
                }
            }
        }

        // Sistema de M√©tricas
        class MetricsManager {
            constructor() {
                this.metrics = {
                    transactions: 0,
                    success: 0,
                    errors: 0,
                    totalTime: 0,
                    startTime: Date.now()
                };
                this.loadFromStorage();
            }

            recordTransaction(success, processingTime) {
                this.metrics.transactions++;
                this.metrics.totalTime += processingTime;
                
                if (success) {
                    this.metrics.success++;
                } else {
                    this.metrics.errors++;
                }
                
                this.saveToStorage();
                this.updateDisplay();
            }

            getMetrics() {
                const avgTime = this.metrics.transactions > 0 
                    ? Math.round(this.metrics.totalTime / this.metrics.transactions) 
                    : 0;
                
                return {
                    ...this.metrics,
                    avgTime: avgTime,
                    uptime: Date.now() - this.metrics.startTime,
                    successRate: this.metrics.transactions > 0 
                        ? Math.round((this.metrics.success / this.metrics.transactions) * 100) 
                        : 0
                };
            }

            updateDisplay() {
                const metrics = this.getMetrics();
                document.getElementById('metricTransactions').textContent = metrics.transactions;
                document.getElementById('metricSuccess').textContent = metrics.success;
                document.getElementById('metricErrors').textContent = metrics.errors;
                document.getElementById('metricAvgTime').textContent = metrics.avgTime + 'ms';
            }

            reset() {
                this.metrics = {
                    transactions: 0,
                    success: 0,
                    errors: 0,
                    totalTime: 0,
                    startTime: Date.now()
                };
                this.saveToStorage();
                this.updateDisplay();
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('metrics_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.metrics = { ...this.metrics, ...data };
                    }
                } catch (error) {
                    logger.error('Erro ao carregar m√©tricas', error);
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('metrics_data', JSON.stringify(this.metrics));
                } catch (error) {
                    logger.error('Erro ao salvar m√©tricas', error);
                }
            }
        }

        // Sistema de Webhook
        class WebhookManager {
            constructor() {
                this.webhookLogs = [];
                this.maxLogs = 50;
                this.loadFromStorage();
            }

            logWebhookEvent(event, data, success = true) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    event: event,
                    data: data,
                    success: success
                };
                
                this.webhookLogs.unshift(logEntry);
                if (this.webhookLogs.length > this.maxLogs) {
                    this.webhookLogs.pop();
                }
                
                this.saveToStorage();
                logger.info(`Webhook ${event}`, { success, data });
            }

            simulateWebhookEvent(eventType, transactionId = null) {
                const events = {
                    'TRANSACTION_PAID': {
                        event: 'TRANSACTION_PAID',
                        token: 'tbdeizos8f',
                        transaction: {
                            id: transactionId || 'sim_' + Date.now(),
                            identifier: 'pedido-' + Date.now(),
                            status: 'COMPLETED',
                            paymentMethod: 'PIX',
                            amount: 19.90,
                            createdAt: new Date().toISOString(),
                            payedAt: new Date().toISOString()
                        },
                        client: {
                            id: 'client_' + Date.now(),
                            name: 'Cliente Teste',
                            email: 'teste@exemplo.com',
                            phone: '(11) 99999-9999',
                            document: '123.456.789-00'
                        }
                    },
                    'TRANSACTION_CREATED': {
                        event: 'TRANSACTION_CREATED',
                        token: 'tbdeizos8f',
                        transaction: {
                            id: transactionId || 'sim_' + Date.now(),
                            identifier: 'pedido-' + Date.now(),
                            status: 'PENDING',
                            paymentMethod: 'PIX',
                            amount: 19.90,
                            createdAt: new Date().toISOString()
                        },
                        client: {
                            id: 'client_' + Date.now(),
                            name: 'Cliente Teste',
                            email: 'teste@exemplo.com',
                            phone: '(11) 99999-9999',
                            document: '123.456.789-00'
                        }
                    }
                };

                const eventData = events[eventType];
                if (eventData) {
                    this.logWebhookEvent(eventType, eventData, true);
                    return eventData;
                }
                return null;
            }

            getWebhookLogs() {
                return this.webhookLogs;
            }

            clearLogs() {
                this.webhookLogs = [];
                this.saveToStorage();
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('webhook_logs');
                    if (stored) {
                        this.webhookLogs = JSON.parse(stored);
                    }
                } catch (error) {
                    logger.error('Erro ao carregar logs de webhook', error);
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('webhook_logs', JSON.stringify(this.webhookLogs));
                } catch (error) {
                    logger.error('Erro ao salvar logs de webhook', error);
                }
            }
        }

        // Instanciar managers
        const idempotencyManager = new IdempotencyManager();
        const metricsManager = new MetricsManager();
        const webhookManager = new WebhookManager();

        $(document).ready(function() {
            logger.info('Sistema de teste PIX inicializado');
            logger.info('Configura√ß√µes carregadas', {
                publicKey: OASYFY_CONFIG.PUBLIC_KEY ? 'Configurada' : 'N√£o configurada',
                secretKey: OASYFY_CONFIG.SECRET_KEY ? 'Configurada' : 'N√£o configurada',
                apiBaseUrl: OASYFY_CONFIG.API_BASE_URL,
                webhookUrl: OASYFY_CONFIG.WEBHOOK_URL
            });

            // Inicializar m√©tricas
            metricsManager.updateDisplay();
            
            // Log de inicializa√ß√£o dos sistemas
            logger.info('Sistemas inicializados', {
                idempotency: 'Cache carregado com ' + idempotencyManager.getCacheStats().size + ' entradas',
                metrics: 'M√©tricas carregadas: ' + metricsManager.getMetrics().transactions + ' transa√ß√µes',
                webhook: 'Logs de webhook carregados: ' + webhookManager.getWebhookLogs().length + ' eventos'
            });

            // Teste de conex√£o
            $('#testConnection').on('click', async function() {
                const btn = $(this);
                const originalText = btn.html();
                
                logger.info('Iniciando teste de conectividade com API');
                btn.html('<i class="fas fa-spinner fa-spin"></i> Testando...');
                btn.prop('disabled', true);

                try {
                    logger.debug('Enviando requisi√ß√£o de teste para /api-proxy.php');
                    const isConnected = await pixIntegration.testConnection();
                    
                    if (isConnected) {
                        logger.info('‚úÖ Teste de conectividade bem-sucedido');
                        $('#connectionStatus').text('‚úÖ Conectado com sucesso!');
                    } else {
                        logger.error('‚ùå Teste de conectividade falhou');
                        $('#connectionStatus').text('‚ùå Erro na conex√£o');
                    }
                    $('#testResults').show();
                } catch (error) {
                    logger.error('‚ùå Erro no teste de conectividade', {
                        error: error.message,
                        stack: error.stack
                    });
                    $('#connectionStatus').text('‚ùå Erro: ' + error.message);
                    $('#testResults').show();
                }

                btn.html(originalText);
                btn.prop('disabled', false);
            });

            // Bot√µes de debug avan√ßado
            $('#clearLogs').on('click', function() {
                logger.clear();
                logger.info('Logs limpos pelo usu√°rio');
            });

            $('#exportLogs').on('click', function() {
                const logsData = {
                    timestamp: new Date().toISOString(),
                    logs: logger.logs,
                    config: {
                        publicKey: OASYFY_CONFIG.PUBLIC_KEY ? 'Configurada' : 'N√£o configurada',
                        secretKey: OASYFY_CONFIG.SECRET_KEY ? 'Configurada' : 'N√£o configurada',
                        apiBaseUrl: OASYFY_CONFIG.API_BASE_URL,
                        webhookUrl: OASYFY_CONFIG.WEBHOOK_URL
                    }
                };
                
                const blob = new Blob([JSON.stringify(logsData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pix-test-logs-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logger.info('Logs exportados com sucesso');
            });

            $('#testCredentials').on('click', async function() {
                logger.info('üîë Testando credenciais da Oasy.fy');
                
                try {
                    const response = await fetch('/api-proxy.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'test_credentials'
                        })
                    });

                    const data = await response.json();
                    logger.info('Resposta do teste de credenciais', data);
                    
                    if (data.success) {
                        logger.info('‚úÖ Credenciais v√°lidas!');
                    } else {
                        logger.error('‚ùå Credenciais inv√°lidas', data.error);
                    }
                } catch (error) {
                    logger.error('‚ùå Erro ao testar credenciais', error);
                }
            });

            $('#testProxy').on('click', async function() {
                logger.info('üîÑ Testando proxy da API');
                
                try {
                    const testData = {
                        action: 'test_proxy',
                        timestamp: new Date().toISOString()
                    };
                    
                    logger.debug('Dados enviados para teste do proxy', testData);
                    
                    const response = await fetch('/api-proxy.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testData)
                    });

                    const data = await response.json();
                    logger.info('Resposta do teste do proxy', data);
                    
                    if (response.ok) {
                        logger.info('‚úÖ Proxy funcionando corretamente!');
                    } else {
                        logger.error('‚ùå Erro no proxy', data);
                    }
                } catch (error) {
                    logger.error('‚ùå Erro ao testar proxy', error);
                }
            });

            $('#validateData').on('click', function() {
                logger.info('‚úÖ Validando dados de exemplo');
                
                const testClientData = pixIntegration.generateRandomClientData();
                logger.debug('Dados de cliente gerados para valida√ß√£o', testClientData);
                
                const validationResult = pixIntegration.validateClientData(testClientData);
                logger.info('Resultado da valida√ß√£o', validationResult);
                
                if (validationResult.isValid) {
                    logger.info('‚úÖ Dados v√°lidos!');
                } else {
                    logger.error('‚ùå Dados inv√°lidos', validationResult.errors);
                }
            });

            $('#showConfig').on('click', function() {
                logger.info('‚öôÔ∏è Exibindo configura√ß√µes atuais');
                
                const config = {
                    publicKey: OASYFY_CONFIG.PUBLIC_KEY ? `${OASYFY_CONFIG.PUBLIC_KEY.substring(0, 10)}...` : 'N√£o configurada',
                    secretKey: OASYFY_CONFIG.SECRET_KEY ? `${OASYFY_CONFIG.SECRET_KEY.substring(0, 10)}...` : 'N√£o configurada',
                    apiBaseUrl: OASYFY_CONFIG.API_BASE_URL,
                    webhookUrl: OASYFY_CONFIG.WEBHOOK_URL,
                    products: OASYFY_CONFIG.SYSTEM_CONFIG.PRODUCTS,
                    defaultClient: OASYFY_CONFIG.SYSTEM_CONFIG.DEFAULT_CLIENT
                };
                
                logger.info('Configura√ß√µes do sistema', config);
                
                // Mostrar em modal tamb√©m
                Swal.fire({
                    title: 'Configura√ß√µes Atuais',
                    html: `
                        <div class="text-start">
                            <p><strong>Chave P√∫blica:</strong> ${config.publicKey}</p>
                            <p><strong>Chave Privada:</strong> ${config.secretKey}</p>
                            <p><strong>API Base URL:</strong> ${config.apiBaseUrl}</p>
                            <p><strong>Webhook URL:</strong> ${config.webhookUrl}</p>
                            <p><strong>Produtos:</strong> ${Object.keys(config.products).length} configurados</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            // ===== WEBHOOK EVENT HANDLERS =====
            $('#testWebhook').on('click', async function() {
                logger.info('üîó Testando webhook endpoint');
                
                try {
                    const response = await fetch('/webhook-example.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            event: 'TEST_WEBHOOK',
                            token: 'tbdeizos8f',
                            timestamp: new Date().toISOString()
                        })
                    });

                    const data = await response.json();
                    logger.info('Resposta do webhook', data);
                    
                    if (response.ok) {
                        logger.info('‚úÖ Webhook funcionando!');
                        webhookManager.logWebhookEvent('TEST_WEBHOOK', data, true);
                    } else {
                        logger.error('‚ùå Erro no webhook', data);
                        webhookManager.logWebhookEvent('TEST_WEBHOOK', data, false);
                    }
                } catch (error) {
                    logger.error('‚ùå Erro ao testar webhook', error);
                    webhookManager.logWebhookEvent('TEST_WEBHOOK', { error: error.message }, false);
                }
            });

            $('#simulatePaid').on('click', function() {
                logger.info('üí∞ Simulando evento TRANSACTION_PAID');
                const eventData = webhookManager.simulateWebhookEvent('TRANSACTION_PAID');
                
                if (eventData) {
                    Swal.fire({
                        title: 'Evento Simulado',
                        html: `
                            <div class="text-start">
                                <p><strong>Evento:</strong> ${eventData.event}</p>
                                <p><strong>Transaction ID:</strong> ${eventData.transaction.id}</p>
                                <p><strong>Status:</strong> ${eventData.transaction.status}</p>
                                <p><strong>Valor:</strong> R$ ${eventData.transaction.amount}</p>
                                <p><strong>Cliente:</strong> ${eventData.client.name}</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                }
            });

            $('#simulateCreated').on('click', function() {
                logger.info('‚ûï Simulando evento TRANSACTION_CREATED');
                const eventData = webhookManager.simulateWebhookEvent('TRANSACTION_CREATED');
                
                if (eventData) {
                    Swal.fire({
                        title: 'Evento Simulado',
                        html: `
                            <div class="text-start">
                                <p><strong>Evento:</strong> ${eventData.event}</p>
                                <p><strong>Transaction ID:</strong> ${eventData.transaction.id}</p>
                                <p><strong>Status:</strong> ${eventData.transaction.status}</p>
                                <p><strong>Valor:</strong> R$ ${eventData.transaction.amount}</p>
                                <p><strong>Cliente:</strong> ${eventData.client.name}</p>
                            </div>
                        `,
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                }
            });

            $('#testCallbackUrl').on('click', async function() {
                logger.info('üîó Testando callback URL');
                
                try {
                    const callbackUrl = OASYFY_CONFIG.WEBHOOK_URL;
                    logger.info('URL do callback', callbackUrl);
                    
                    // Simular teste de acessibilidade
                    const response = await fetch('/api-proxy.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'test_callback_url',
                            callbackUrl: callbackUrl
                        })
                    });

                    const data = await response.json();
                    logger.info('Resultado do teste de callback', data);
                    
                    if (data.success) {
                        logger.info('‚úÖ Callback URL acess√≠vel!');
                    } else {
                        logger.error('‚ùå Callback URL n√£o acess√≠vel', data.error);
                    }
                } catch (error) {
                    logger.error('‚ùå Erro ao testar callback URL', error);
                }
            });

            $('#clearWebhookLogs').on('click', function() {
                webhookManager.clearLogs();
                logger.info('üßπ Logs de webhook limpos');
                Swal.fire({
                    title: 'Logs Limpos',
                    text: 'Logs de webhook foram limpos com sucesso',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            });

            // ===== IDEMPOT√äNCIA EVENT HANDLERS =====
            $('#testIdempotency').on('click', async function() {
                logger.info('üîÑ Testando idempot√™ncia');
                
                const testTransactionId = 'test_idempotency_' + Date.now();
                
                // Primeira tentativa
                logger.info('Primeira tentativa de processamento');
                if (idempotencyManager.isTransactionProcessed(testTransactionId)) {
                    logger.warn('Transa√ß√£o j√° processada (primeira tentativa)');
                } else {
                    logger.info('Processando transa√ß√£o pela primeira vez');
                    idempotencyManager.markTransactionAsProcessed(testTransactionId, 'TRANSACTION_PAID', { amount: 19.90 });
                }
                
                // Segunda tentativa (deve ser detectada como duplicada)
                logger.info('Segunda tentativa de processamento');
                if (idempotencyManager.isTransactionProcessed(testTransactionId)) {
                    logger.info('‚úÖ Idempot√™ncia funcionando! Transa√ß√£o duplicada detectada');
                    Swal.fire({
                        title: 'Idempot√™ncia OK',
                        text: 'Sistema detectou transa√ß√£o duplicada corretamente',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    logger.error('‚ùå Idempot√™ncia falhou! Transa√ß√£o duplicada n√£o detectada');
                    Swal.fire({
                        title: 'Idempot√™ncia Falhou',
                        text: 'Sistema n√£o detectou transa√ß√£o duplicada',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });

            $('#showCache').on('click', function() {
                const cacheStats = idempotencyManager.getCacheStats();
                logger.info('üìä Estat√≠sticas do cache', cacheStats);
                
                const cacheHtml = cacheStats.entries.map(entry => `
                    <div class="border-bottom py-2">
                        <strong>ID:</strong> ${entry.id}<br>
                        <strong>Evento:</strong> ${entry.event}<br>
                        <strong>Timestamp:</strong> ${entry.timestamp}<br>
                        <strong>Idade:</strong> ${Math.round(entry.age / 1000)}s
                    </div>
                `).join('');
                
                Swal.fire({
                    title: `Cache de Idempot√™ncia (${cacheStats.size} entradas)`,
                    html: cacheHtml || '<p>Cache vazio</p>',
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            $('#clearCache').on('click', function() {
                idempotencyManager.clearCache();
                logger.info('üßπ Cache de idempot√™ncia limpo');
                Swal.fire({
                    title: 'Cache Limpo',
                    text: 'Cache de idempot√™ncia foi limpo com sucesso',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            });

            // ===== MONITORAMENTO EVENT HANDLERS =====
            $('#getMetrics').on('click', function() {
                const metrics = metricsManager.getMetrics();
                logger.info('üìä M√©tricas do sistema', metrics);
                
                Swal.fire({
                    title: 'M√©tricas do Sistema',
                    html: `
                        <div class="text-start">
                            <p><strong>Transa√ß√µes:</strong> ${metrics.transactions}</p>
                            <p><strong>Sucessos:</strong> ${metrics.success}</p>
                            <p><strong>Erros:</strong> ${metrics.errors}</p>
                            <p><strong>Taxa de Sucesso:</strong> ${metrics.successRate}%</p>
                            <p><strong>Tempo M√©dio:</strong> ${metrics.avgTime}ms</p>
                            <p><strong>Uptime:</strong> ${Math.round(metrics.uptime / 1000)}s</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            $('#getStats').on('click', function() {
                const metrics = metricsManager.getMetrics();
                const cacheStats = idempotencyManager.getCacheStats();
                const webhookLogs = webhookManager.getWebhookLogs();
                
                logger.info('üìà Estat√≠sticas completas', {
                    metrics,
                    cache: cacheStats,
                    webhookLogs: webhookLogs.length
                });
                
                Swal.fire({
                    title: 'Estat√≠sticas Completas',
                    html: `
                        <div class="text-start">
                            <h6>M√©tricas:</h6>
                            <p><strong>Transa√ß√µes:</strong> ${metrics.transactions}</p>
                            <p><strong>Taxa de Sucesso:</strong> ${metrics.successRate}%</p>
                            
                            <h6 class="mt-3">Cache:</h6>
                            <p><strong>Entradas:</strong> ${cacheStats.size}</p>
                            
                            <h6 class="mt-3">Webhook:</h6>
                            <p><strong>Logs:</strong> ${webhookLogs.length}</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            $('#monitorStatus').on('click', async function() {
                logger.info('üíì Verificando status do sistema');
                
                try {
                    const response = await fetch('/monitor-webhook.php');
                    const data = await response.text();
                    
                    if (response.ok) {
                        logger.info('‚úÖ Monitor webhook acess√≠vel');
                        Swal.fire({
                            title: 'Status do Sistema',
                            text: 'Monitor webhook est√° funcionando',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        logger.error('‚ùå Monitor webhook n√£o acess√≠vel');
                        Swal.fire({
                            title: 'Status do Sistema',
                            text: 'Monitor webhook n√£o est√° acess√≠vel',
                            icon: 'warning',
                            confirmButtonText: 'OK'
                        });
                    }
                } catch (error) {
                    logger.error('‚ùå Erro ao verificar status', error);
                    Swal.fire({
                        title: 'Status do Sistema',
                        text: 'Erro ao verificar status do monitor',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });

            $('#performanceTest').on('click', async function() {
                logger.info('‚ö° Iniciando teste de performance');
                
                const iterations = 5;
                const results = [];
                
                Swal.fire({
                    title: 'Teste de Performance',
                    text: `Executando ${iterations} requisi√ß√µes...`,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                for (let i = 0; i < iterations; i++) {
                    const startTime = Date.now();
                    
                    try {
                        const response = await fetch('/api-proxy.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: 'test_connection'
                            })
                        });
                        
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        
                        results.push({
                            iteration: i + 1,
                            duration: duration,
                            success: response.ok
                        });
                        
                        logger.debug(`Itera√ß√£o ${i + 1}: ${duration}ms`);
                    } catch (error) {
                        results.push({
                            iteration: i + 1,
                            duration: 0,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                const avgTime = results.reduce((sum, r) => sum + r.duration, 0) / results.length;
                const successCount = results.filter(r => r.success).length;
                
                Swal.close();
                
                logger.info('üìä Resultados do teste de performance', {
                    avgTime: Math.round(avgTime),
                    successRate: (successCount / iterations) * 100,
                    results
                });
                
                Swal.fire({
                    title: 'Teste de Performance Conclu√≠do',
                    html: `
                        <div class="text-start">
                            <p><strong>Itera√ß√µes:</strong> ${iterations}</p>
                            <p><strong>Tempo M√©dio:</strong> ${Math.round(avgTime)}ms</p>
                            <p><strong>Taxa de Sucesso:</strong> ${Math.round((successCount / iterations) * 100)}%</p>
                            <p><strong>Sucessos:</strong> ${successCount}/${iterations}</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            // Bot√µes de pagamento
            $('#btn-1-mes').on('click', function() {
                generatePixPayment(19.90, '1 m√™s');
            });

            $('#btn-3-meses').on('click', function() {
                generatePixPayment(41.90, '3 meses (30% off)');
            });

            $('#btn-6-meses').on('click', function() {
                generatePixPayment(59.90, '6 meses (50% off)');
            });

            // Fun√ß√£o para gerar pagamento PIX
            async function generatePixPayment(amount, planName) {
                const startTime = Date.now();
                logger.info(`üöÄ Iniciando gera√ß√£o de PIX para ${planName} - R$ ${amount}`);
                
                try {
                    // Mostra loading
                    Swal.fire({
                        title: 'Gerando PIX...',
                        text: 'Aguarde enquanto processamos seu pagamento',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Dados do pagamento (dados do cliente ser√£o gerados automaticamente)
                    const paymentData = {
                        amount: amount,
                        products: [{
                            id: 'assinatura-privacy',
                            name: `Assinatura Privacy - ${planName}`,
                            quantity: 1,
                            price: amount
                        }],
                        metadata: {
                            plan: planName,
                            source: 'privacy-checkout-test',
                            timestamp: new Date().toISOString()
                        }
                    };

                    logger.debug('Dados do pagamento preparados', paymentData);

                    // Gera dados do cliente
                    logger.info('Gerando dados aleat√≥rios do cliente');
                    const clientData = pixIntegration.generateRandomClientData();
                    logger.debug('Dados do cliente gerados', clientData);

                    // Valida dados antes de enviar
                    logger.info('Validando dados antes do envio');
                    const validationResult = pixIntegration.validateClientData(clientData);
                    if (!validationResult.isValid) {
                        logger.error('‚ùå Dados do cliente inv√°lidos', validationResult.errors);
                        throw new Error(`Dados inv√°lidos: ${validationResult.errors.join(', ')}`);
                    }
                    logger.info('‚úÖ Dados do cliente validados com sucesso');

                    // Gera o PIX (com dados aleat√≥rios do cliente)
                    logger.info('Enviando requisi√ß√£o para API Oasy.fy');
                    const result = await pixIntegration.generatePixPayment(paymentData);

                    const processingTime = Date.now() - startTime;
                    logger.info(`‚è±Ô∏è Processamento conclu√≠do em ${processingTime}ms`);

                    // Fecha o loading
                    Swal.close();

                    if (result.success) {
                        logger.info('‚úÖ PIX gerado com sucesso!', {
                            transactionId: result.data.transactionId,
                            status: result.data.status,
                            amount: result.data.amount,
                            processingTime: processingTime
                        });

                        // Registrar m√©tricas de sucesso
                        metricsManager.recordTransaction(true, processingTime);

                        // Verificar idempot√™ncia
                        if (idempotencyManager.isTransactionProcessed(result.data.transactionId)) {
                            logger.warn('‚ö†Ô∏è Transa√ß√£o j√° processada anteriormente (idempot√™ncia)');
                        } else {
                            // Marcar como processada
                            idempotencyManager.markTransactionAsProcessed(
                                result.data.transactionId, 
                                'TRANSACTION_CREATED', 
                                { amount: amount, planName: planName }
                            );
                            logger.info('‚úÖ Transa√ß√£o marcada como processada no cache de idempot√™ncia');
                        }

                        // Simular evento de webhook TRANSACTION_CREATED
                        webhookManager.simulateWebhookEvent('TRANSACTION_CREATED', result.data.transactionId);

                        // Exibe o modal com QR Code
                        pixIntegration.displayPixData(result.data, result.clientData);
                        
                        // Salva o transactionId para consultas futuras
                        localStorage.setItem('currentTransactionId', result.data.transactionId);
                        logger.info('TransactionId salvo no localStorage', result.data.transactionId);
                        
                        // Log detalhado da resposta
                        logger.debug('Resposta completa da API', result.data);
                        logger.debug('Dados do cliente utilizados', result.clientData);
                    } else {
                        logger.error('‚ùå Erro ao gerar PIX', {
                            error: result.error,
                            details: result.details,
                            processingTime: processingTime
                        });

                        // Registrar m√©tricas de erro
                        metricsManager.recordTransaction(false, processingTime);

                        // Log de erro no webhook
                        webhookManager.logWebhookEvent('TRANSACTION_ERROR', {
                            error: result.error,
                            details: result.details,
                            amount: amount,
                            planName: planName
                        }, false);

                        // Mostra erro detalhado
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro ao gerar PIX',
                            html: `
                                <div class="text-start">
                                    <p><strong>Erro:</strong> ${result.error || 'Ocorreu um erro inesperado'}</p>
                                    ${result.details ? `<p><strong>Detalhes:</strong> ${result.details}</p>` : ''}
                                    <p><strong>Tempo de processamento:</strong> ${processingTime}ms</p>
                                    <p><strong>Verifique os logs no console para mais detalhes.</strong></p>
                                </div>
                            `,
                            confirmButtonText: 'Tentar novamente'
                        });
                    }
                } catch (error) {
                    const processingTime = Date.now() - startTime;
                    logger.error('‚ùå Erro cr√≠tico ao gerar PIX', {
                        error: error.message,
                        stack: error.stack,
                        processingTime: processingTime,
                        amount: amount,
                        planName: planName
                    });

                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro Cr√≠tico',
                        html: `
                            <div class="text-start">
                                <p><strong>Erro:</strong> ${error.message}</p>
                                <p><strong>Tempo de processamento:</strong> ${processingTime}ms</p>
                                <p><strong>Verifique os logs no console para mais detalhes.</strong></p>
                            </div>
                        `,
                        confirmButtonText: 'OK'
                    });
                }
            }
        });
    </script>
</body>
</html>
